#!/bin/bash

# Color codes
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Prompt for username and domain
read -p "Enter the username to remove: " username
read -p "Enter the domain for the user to remove (e.g., example.com): " domain

# Check if the user exists
if id "$username" &>/dev/null; then
    echo -e "${YELLOW}Removing user $username...${NC}"

    # Remove the user's home directory and files
    sudo deluser --remove-home "$username"
    echo -e "${GREEN}User $username removed successfully.${NC}"
else
    echo -e "${RED}User $username does not exist. Proceeding to remove Apache configuration...${NC}"
fi

# Prompt to remove the Apache configuration
read -p "Do you want to remove the Apache configuration for $domain? (y/n): " remove_apache
if [[ "$remove_apache" == "y" ]]; then
    # Define the configuration files
    config_file="/etc/apache2/sites-available/${domain}.conf"
    ssl_config_file="/etc/apache2/sites-available/${domain}-le-ssl.conf"
    cert_dir="/etc/letsencrypt/live/${domain}"

    # Remove the main configuration file
    if [ -f "$config_file" ]; then
        echo -e "${YELLOW}Removing Apache configuration for $domain...${NC}"
        sudo a2dissite "${domain}.conf"  # Disable the site
        sudo rm "$config_file"            # Remove the config file
        echo -e "${GREEN}Apache configuration for $domain removed successfully.${NC}"
    else
        echo -e "${RED}No Apache configuration file found for $domain.${NC}"
    fi

    # Remove the SSL configuration file if it exists
    if [ -f "$ssl_config_file" ]; then
        echo -e "${YELLOW}Removing SSL configuration for $domain...${NC}"
        sudo rm "$ssl_config_file"         # Remove the SSL config file
        echo -e "${GREEN}SSL configuration for $domain removed successfully.${NC}"
    else
        echo -e "${RED}No SSL configuration file found for $domain.${NC}"
    fi

    # Remove Certbot certificates
    if [ -d "$cert_dir" ]; then
        echo -e "${YELLOW}Removing Certbot certificate for $domain...${NC}"
        sudo certbot delete --cert-name "$domain"  # This will prompt for confirmation
        echo -e "${GREEN}Certbot certificate for $domain removed successfully.${NC}"
    else
        echo -e "${RED}No Certbot certificate found for $domain.${NC}"
    fi
fi